<html>
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">

    <!-- Range Slider -->
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script>
        $(function () {
            $("#slider-range").slider({
                range: true,
                min: {{filters['seasonYear'].available_values[0]}},
                max: {{filters['seasonYear'].available_values[-1]}},
                values: [{{filters['seasonYear'].available_values[0]}}, {{filters['seasonYear'].available_values[-1]}}],

                slide: function (event, ui) {
                    $("#seasonYear_min").val(ui.values[0] );
                    $("#seasonYear_max").val(ui.values[1] );
                }
            });
            $("#seasonYear_min").val($("#slider-range").slider("values", 0));
            $("#seasonYear_max").val($("#slider-range").slider("values", 1));
        });
    </script>

    <!-- Select2 Multiselect Dropdown -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        $(document).ready(function () {
            $('.js-example-basic-multiple').select2();
        });
    </script>

    <!-- D3js -->
    <script src="https://d3js.org/d3.v6.min.js"></script>

    <!-- Our Stuff -->
    <title>Maps of Anime</title>
    <link rel="stylesheet" href="{{ url_for('static',filename='styles/styles.css') }}">
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.jpg') }}">
</head>
<body >
<h1>Maps of Anime</h1>
<form method="post">
    <table id="form">
        <tr>
            <td><label>Studios: </label></td>
            <td><select class="js-example-basic-multiple" name="studios[]" multiple="multiple">
                <option value="All" {% if "All" in filters['studios'].selected_values %} selected="true" {% endif %}>All</option>
                {%  for studio in filters['studios'].available_values  %}
                    <option value="{{ studio }}" {% if studio in filters['studios'].selected_values  %} selected="true" {% endif %}> {{ studio }}</option>
                {% endfor %}
            </select></td>
        </tr>
        <tr>
            <td><label>Release Year: </label></td>
            <td>
                <input type="text" id="seasonYear_min" name="seasonYear_min" readonly style="width: 40px; border:0;  font-weight:bold;"> - <input type="text" id="seasonYear_max" name="seasonYear_max" readonly style="width: 40px; border:0;  font-weight:bold;">
                <div id="slider-range"></div>
            </td>

        </tr>
        <tr>
            <td><label>Media Type: </label></td>
            <td><select class="js-example-basic-multiple" name="format[]" multiple="multiple">
                <option value="All" {% if "All" in filters['format'].selected_values  %} selected="true" {% endif %}>All</option>
                {%  for format in filters['format'].available_values  %}
                    <option value="{{ format }}" {% if format in filters['format'].selected_values  %} selected="true" {% endif %}> {{ format }}</option>
                {% endfor %}
            </select></td>
        </tr>
    </table>

    <input type="submit">
</form>


<script>
    var width = 960, height = 500, displayThreshold = 2000;
    var c10 = d3.schemePaired;
    //var vertices = d3.range(10).map(function(d) {
    //  return [Math.random() * width, Math.random() * height];
    //});
    var vertices = {{ map_data | safe }};
    vertices.forEach(x => {x[0] = (x[0] * width/2) + width/2; x[1] = (x[1] * height/2) + height/2})
    //console.log(vertices);
    data = vertices;
    orient = ({
        top: text => text.attr("text-anchor", "middle").attr("y", -6),
        right: text => text.attr("text-anchor", "start").attr("dy", "0.35em").attr("x", 6),
        bottom: text => text.attr("text-anchor", "middle").attr("dy", "0.71em").attr("y", 6),
        left: text => text.attr("text-anchor", "end").attr("dy", "0.35em").attr("x", -6)
    })


    var svg = d3.select("body").append("svg").attr("viewBox", [0, 0, width, height]);//.attr("width", width).attr("height", height);
    const g = svg.append("g");
    var path = g.selectAll("path");


    const delaunay = d3.Delaunay.from(data);
    const voronoi = delaunay.voronoi([0, 0, width, height]);
    const cells = data.map((d, i) => [d, voronoi.cellPolygon(i)]);

    path.data( cells  ).enter().append("path")
        .attr("stroke","white")
        .attr("fill", function(d,i) {return c10[i % 10]} )
        //    .attr("d", function(d) { return "M" + d.join("L") + "Z" } );
        .attr("d", polygon);

    function polygon(b) {
        //console.log(b)
        d = b[1]
        //TODO why can this be null?
        if (b[0][2] !== -1 || d === null)
            return null;
        else
            return "M" + d.join("L") + "Z";
    }

    g.selectAll("circle").data(vertices).enter().append("circle").attr("r", 0.3)
        //.attr("transform", function(d) { return "translate(" + d + ")"; })
        .attr("cx", function(d) { return d[0]; } )
        .attr("cy", function(d) { return d[1]; } );
    //console.log({{ tags | safe  }})
    g.attr("class", "label")
        .style("font", "5px sans-serif")
        .selectAll("text")
        .data(cells)
        .join("text")
        .each(function([[x, y], cell]) {
            //console.log(d3.polygonArea(cell));
            cell.scaleThreshold = Math.sqrt(displayThreshold / -d3.polygonArea(cell));
            cell.opacityScale = d3.scaleLinear().domain([cell.scaleThreshold, cell.scaleThreshold * 2]).range([0, 1]);
            //console.log(cell)
            const [cx, cy] = d3.polygonCentroid(cell);
            const angle = (Math.round(Math.atan2(cy - y, cx - x) / Math.PI * 2) + 4) % 4;
            d3.select(this).call(angle === 0 ? orient.right
                : angle === 3 ? orient.top
                    : angle === 1 ? orient.bottom
                        : orient.left);
        })
        .attr("transform", ([d]) => `translate(${d.slice(0, -1)})`)
        //.attr("display", ([, cell]) => -d3.polygonArea(cell) > 2000 ? null : "none")
        .text((d, i) => {{ tags | safe  }}[i])
        .attr('opacity', function(d) {
            if (d.scaleThreshold < 1) {
                return 1;
            }
            return 0;
        });


    svg.call(d3.zoom()
        .extent([[0, 0], [width, height]])
        .scaleExtent([1, 16])
        .on("zoom", zoomed));

    function zoomed({transform}) {
        g.attr("transform", transform);
        //g.attr("transform", "translate(" + d3.event.translate + ").scale(" + d3.event.scale + ")");
        //d3.selectAll('circle').attr('transform', function(d) {
        //  return 'translate(' + d + ')scale(' + (1/d3.event.scale) + ')';
        //});

        d3.selectAll('text')
            //.attr('transform', transform)
            .attr('opacity', function(d) {
                if (transform.k > d[1].scaleThreshold) {
                    return d[1].opacityScale(transform.k);
                }
                return 0;
            });
    }
</script>



<!-- Bootstrap Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js" integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf" crossorigin="anonymous"></script>
</body>

</html>
