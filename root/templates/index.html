<html>
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">

    <!-- Range Slider -->
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script>
        $(function () {
            $("#slider-range").slider({
                range: true,
                min: {{filters['seasonYear'].available_values[0]}},
                max: {{filters['seasonYear'].available_values[-1]}},
                values: [{{filters['seasonYear'].available_values[0]}}, {{filters['seasonYear'].available_values[-1]}}],

                slide: function (event, ui) {
                    $("#seasonYear_min").val(ui.values[0] );
                    $("#seasonYear_max").val(ui.values[1] );
                }
            });
            $("#seasonYear_min").val($("#slider-range").slider("values", 0));
            $("#seasonYear_max").val($("#slider-range").slider("values", 1));
        });
    </script>

    <!-- Select2 Multiselect Dropdown -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        $(document).ready(function () {
            $('.js-example-basic-multiple').select2();
        });
    </script>

    <!-- D3js -->
    <script src="https://d3js.org/d3.v6.min.js"></script>

    <!-- Our Stuff -->
    <title>Maps of Anime</title>
    <link rel="stylesheet" href="{{ url_for('static',filename='styles/styles.css') }}">
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.jpg') }}">
</head>
<body >
<h1>Maps of Anime</h1>
<form method="post">
    <table id="form">
        <tr>
            <td><label>Studios: </label></td>
            <td><select class="js-example-basic-multiple" name="studios[]" multiple="multiple">
                <option value="All" {% if "All" in filters['studios'].selected_values %} selected="true" {% endif %}>All</option>
                {%  for studio in filters['studios'].available_values  %}
                    <option value="{{ studio }}" {% if studio in filters['studios'].selected_values  %} selected="true" {% endif %}> {{ studio }}</option>
                {% endfor %}
            </select></td>
        </tr>
        <tr>
            <td><label>Release Year: </label></td>
            <td>
                <input type="text" id="seasonYear_min" name="seasonYear_min" readonly style="width: 40px; border:0;  font-weight:bold;"> - <input type="text" id="seasonYear_max" name="seasonYear_max" readonly style="width: 40px; border:0;  font-weight:bold;">
                <div id="slider-range"></div>
            </td>

        </tr>
        <tr>
            <td><label>Media Type: </label></td>
            <td><select class="js-example-basic-multiple" name="format[]" multiple="multiple">
                <option value="All" {% if "All" in filters['format'].selected_values  %} selected="true" {% endif %}>All</option>
                {%  for format in filters['format'].available_values  %}
                    <option value="{{ format }}" {% if format in filters['format'].selected_values  %} selected="true" {% endif %}> {{ format }}</option>
                {% endfor %}
            </select></td>
        </tr>
    </table>

    <input type="submit">
</form>


<script>
    var width = 960, height = 500;
    var c10 = d3.schemePaired;
    //var vertices = d3.range(10).map(function(d) {
    //  return [Math.random() * width, Math.random() * height];
    //});
    var vertices = {{ map_data | safe }};
    vertices.forEach(x => {x[0] = (x[0] * width/2) + width/2; x[1] = (x[1] * height/2) + height/2})
    console.log(vertices);
    data = vertices;

    var svg = d3.select("body").append("svg").attr("viewBox", [0, 0, width, height]);//.attr("width", width).attr("height", height);
    const g = svg.append("g");
    var path = g.selectAll("path");


    const delaunay = d3.Delaunay.from(data);
    const voronoi = delaunay.voronoi([0, 0, width, height]);

    path.data( voronoi.cellPolygons()  ).enter().append("path")
    .attr("stroke","white")
    .attr("fill", function(d,i) {return c10[i % 10]} )
    //    .attr("d", function(d) { return "M" + d.join("L") + "Z" } );
    .attr("d", polygon);

    function polygon(d) {
        return "M" + d.join("L") + "Z";
    }

    g.selectAll("circle").data(vertices).enter().append("circle").attr("r", 0.3)
    //.attr("transform", function(d) { return "translate(" + d + ")"; })
     .attr("cx", function(d) { return d[0]; } )
     .attr("cy", function(d) { return d[1]; } );

    svg.call(d3.zoom()
      .extent([[0, 0], [width, height]])
      .scaleExtent([1, 80])
      .on("zoom", zoomed));

    function zoomed({transform}) {
        g.attr("transform", transform);
    }
</script>



<!-- Bootstrap Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js" integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf" crossorigin="anonymous"></script>
</body>

</html>
